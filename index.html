<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>LCLS Status</title>
		<meta name="author" content="Matt Gibbs">
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<script src="d3/d3.v2.min.js"></script>
		<script src="d3/cubism.v1.min.js"></script>
		<style>


		.group {
		  margin-bottom: 1em;
		}

		.axis {
		  font: 10px sans-serif;
		  z-index: 2;
		}

		.axis text {
		  stroke: #FFF;
		}

		.axis path {
		  display: none;
		}

		.axis line {
		  stroke: #FFF;
		  shape-rendering: crispEdges;
		}

		.axis.bottom {
		  color: white;
		  bottom: 0px;
		  padding: 24px 0 0 0;
		}

		.horizon {
		  border-bottom: solid 1px #333;
		  overflow: hidden;
		  position: relative;
		}

		.horizon {
		  border-top: solid 1px #333;
		  border-bottom: solid 1px #FFF;
		}

		.horizon + .horizon {
		  border-top: none;
		}

		.horizon canvas {
		  display: block;
		}

		.horizon .title,
		.horizon .value {
		  font-weight: bold;
		  text-rendering: optimizelegibility;
		  bottom: 0;
		  line-height: 30px;
		  margin: 0 6px;
		  position: absolute;
		  white-space: nowrap;
		}

		.horizon .title {
		  left: 0;
		}

		.horizon .value {
		  right: 0;
		}

		.line {
		  background: #FFF;
		  z-index: 2;
		}
		
		li.elogEntry {
			display: inline;
			font-size: 24px;
			line-height: 40px;
			font-weight: bold;
			text-rendering: optimizelegibility;
		}
		
		</style>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="span10">
					<div class="page-header">
						<h1>Linac Status</h1>
					</div>
					<div class="row">
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Machine Rate</h5>
							</div>
							<h1><span id="machineRate" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO467">120 Hz</span></h1>
						</div>
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Bunch Charge</h5>
							</div>
							<h1><span id="bunchCharge" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO470">150 pC</span></h1>
						</div>
						<div class="span6">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>L3 Energy</h5>
							</div>
							<h1><span id="L3Energy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO500" data-precision="2">6.71 GeV</span> + <span id="L3Vernier" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO289">13 MeV</span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span7">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Emittance</h5>
							</div>
							<table class="table" style="font-size: 18px;">
								<thead>
									<tr>
										<th></th>
										<th>X</th>
										<th>Y</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th>OTR-2</th>
										<td id="OTR2XEmit">0.40 / 1.03</td>
										<td id="OTR2YEmit">0.39 / 1.05</td>
									</tr>
									<tr>
										<th>WS12</th>
										<td id="WS12XEmit">0.63 / 1.00</td>
										<td id="WS12YEmit">0.60 / 1.02</td>
									</tr>
									<tr>
										<th>LI28</th>
										<td id="LI28XEmit">0.75 / 1.13</td>
										<td id="LI28YEmit">0.72 / 1.04</td>
									</tr>
									<tr>
										<th>LTU</th>
										<td id="LTUXEmit">0.84 / 1.10</td>
										<td id="LTUYEmit">0.82 / 1.15</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>BC1 Peak Current</h5>
							</div>
							<h1><span id="BC1PeakCurrent" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO485">210 A</span></h1>
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>BC2 Peak Current</h5>
							</div>
							<h1><span id="BC2PeakCurrent" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO195">3100 A</span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>L1S Phase</h5>
							</div>
							<h1><span id="L1SPhase" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO479" data-units="&deg" data-precision="1">-26.5&deg</span></h1>
						</div>
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>L2 Phase</h5>
							</div>
							<h1><span id="L2Phase"  class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO487" data-units="&deg" data-precision="1">-36.4&deg</span></h1>
						</div>
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>L3 Phase</h5>
							</div>
							<h1><span id="L3Phase" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO499" data-units="&deg" data-precision="1">0.0&deg</span></h1>
						</div>
						<div class="span4">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Electron Destination</h5>
							</div>
							<h1><span id="ElectronDestination" class="PVmonitor" data-pv="CUD:MCC0:DESTINATION" data-units="">Undulator</span></h1>
						</div>
					</div>
				</div>
				<div class="span9 offset1"><!-- FEL Status -->
					<div class="page-header">
						<h1>FEL Status</h1>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>FEL Pulse Energy</h5>
							</div>
							<h1><span id="GDETEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO569" data-precision="1">4.3 mJ</span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Photon Energy</h5>
							</div>
							<h1><span id="photonEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO627">2000 eV</span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Amplification Mode</h5>
							</div>
							<h1><span id="amplificationMode">SASE</span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Pulse Length</h5>
							</div>
							<h1><span id="pulseLength" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO820">52 fs</span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Peak Power</h5>
							</div>
							<h1><span id="peakPower" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO821">86 GW</span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Scheduled User</h5>
							</div>
							<h1><span id="scheduledUser">AMO</span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span6">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h5>Dumb Counter PV</h5>
							</div>
							<h1><span id="dumbCounter" class="PVmonitor" data-pv="SIOC:SYS0:ML00:CALC010" data-updatetime="1000"></span></h1>
						</div>
					</div>
				</div>
			</div>
			
			<div class="row">
				<div class="span20">
					<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
						<h5>Latest E-Log Entry</h5>
					</div>
					<ul id="latestElogEntries" class="unstyled" data-updatetime="1000">
					</ul>
					<script>
						setInterval(function(){
							var rightNow = new Date();
							var oneHourAgo = new Date(rightNow - 60*60*1000);
							var endHour = Math.ceil(rightNow.getHours() + rightNow.getMinutes()/60);
							var startHour = Math.floor(oneHourAgo.getHours() + oneHourAgo.getMinutes()/60);
							var entryList = d3.select("#latestElogEntries");
							d3.json("http://mccelog.slac.stanford.edu/elog/dev/mgibbs/dev_elog_display_json.php?shift_field=NONE" + 
									"&sd_Month=" + (oneHourAgo.getMonth()+1) + 
									"&sd_Day=" + oneHourAgo.getDate() + 
									"&sd_Year=" + oneHourAgo.getFullYear() + 
									"&sd_Hour=" + startHour + 
									"&ed_Month=" + (rightNow.getMonth()+1) +
									"&ed_Day=" + rightNow.getDate() +
									"&ed_Year="+ rightNow.getFullYear() +
									"&ed_Hour=" + endHour, 
									function(json){
										var entries = entryList.selectAll(".elogEntry").data(json, function(d){return d.elogid});
										entries.enter().append("li").text(function(d) {return d.title}).classed("elogEntry",true);
										entries.exit().remove();
							});
						},10000);
					</script>
				</div>
			</div>
			<div class="row"><!-- graph row begin -->
				<div class="span20" id="history">
					<div class="page-header">
						<h1>24 Hour History</h1>
					</div>
					<script>
						var context = cubism.context().step(24*60*60*1000/1770).size(1770);
						var fakedata = random("fakedata");
						var morefake = random("morefake");
						d3.select("#history").call(function(div) {
							div.append("div").attr("class","axis").call(context.axis().orient("bottom"));							
							div.selectAll(".horizon")
								.data([fakedata])
								.enter().insert("div",".axis")
								.attr("class","horizon")
								.call(context.horizon()
										.extent([-10, 10])
										.height(150)
										.mode("mirror")
										.title("Gas Detector History")
										.colors(["#3182bd", "#3182bd"]));
						});
					
						function random(name) {
							var value = 0,
								values = [],
								i = 0,
								last;
							return context.metric(function(start, stop, step, callback) {
								//This is just a goofy way to turn a Date object into a number in milliseconds
								start = +start;
								stop = +stop;
								if (isNaN(last)) last = start;
								while (last < stop) {
									last += step;
									value = Math.max(-10, Math.min(10, value + 0.8 * Math.random() - 0.4 + 0.2 * Math.cos(i +=  0.2)));
									values.push(value);
								}
								callback(null, values = values.slice((start - stop) / step));
							}, name);
						}	
					</script>
					<script>
						function bindElementToPV(elem, PV, precision, updateRate) {
							setInterval(function(){
								d3.json("http://lcls-prod02.slac.stanford.edu:8888/PV?PV=" + PV + "&precision=" + precision, function(json){
									if(json["value"]!==undefined){
										d3.select(elem).text(function(d,i) {
											return json["value"] + " " + d.units;
										});
									}
								});
							},updateRate);
						}
						
						d3.selectAll(".PVmonitor").datum(function() { return this.dataset; }).each(function(d) {
							if(d.units==null) {
								setTimeout(function(){
									d3.json("http://lcls-prod02.slac.stanford.edu:8888/PV?PV=" + d.pv + ".EGU", function(json){
										if(json["value"]!==undefined){
											d.units = json["value"];
										} else {
											d.units = "";
										}

									});
								},Math.random()*3000);	
							}
							if(d.precision==null) {
								d.precision = 0;
							}
							d3.select(this).text("?");
							//Randomize when these fire a little bit, so that we don't dump a bunch of requests on the server
							//all at the exact same time.
							setInterval(function(){
								bindElementToPV(this, d.pv, d.precision, d.updatetime ? d.updatetime : 10000);
							},Math.random()*2000);
						});
					</script>
				</div>
			</div><!-- graph row end -->	
		</div><!-- container end -->
		<!--<script src="bootstrap/js/bootstrap.min.js"></script>-->
	</body>
</html>